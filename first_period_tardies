/* This query pull first period tardies at a site in a given year. First period is defined in the CTE as any class starting
before 8:29 AM (adjust time in line 28).

This is WIP - code review scheduled 2/27, hasn't been deeply QA'ed
*/

WITH early_timeblocks AS (

    SELECT
      tt.timeblock_id,
      tt.start_time,
      tt.end_time,
      tt.day_of_week,
      day_types.status_text,
      timeblocks.timeblock_name,
      sta.section_id,
      timeblock_dates.date,
      date_part('dow',timeblock_dates.date)


    FROM timeblock_times tt
      LEFT JOIN day_types ON tt.day_type_id = day_types.day_type_id
      LEFT JOIN timeblocks ON tt.timeblock_id = timeblocks.timeblock_id
      LEFT JOIN section_timeblock_aff sta ON timeblocks.timeblock_id = sta.timeblock_id
      RIGHT JOIN section_term_aff ON sta.section_id = section_term_aff.section_id
      LEFT JOIN matviews.timeblock_dates ON timeblocks.timeblock_id = timeblock_dates.timeblock_id

    WHERE start_time < '08:29'
          AND site_id = 12
          AND term_id = 139 --Olympus 2017
          AND day_of_week = date_part('dow',timeblock_dates.date)
    ORDER BY date)

SELECT
  students.local_student_id,
  satt.date,
  date_part('dow', satt.date) AS day_of_week,
  satt.sa_section_id

FROM student_attendance satt
  LEFT JOIN section_term_aff ON satt.sa_section_id = section_term_aff.section_id
  LEFT JOIN students ON satt.sa_student_id = students.student_id
  RIGHT JOIN early_timeblocks ON (early_timeblocks.section_id = satt.sa_section_id AND early_timeblocks.date = satt.date)

WHERE satt.attendance_flag_id = 5 -- Tardy Flag

GROUP BY
  students.local_student_id,
  satt.date,
  satt.sa_section_id

ORDER BY local_student_id, satt.date DESC
