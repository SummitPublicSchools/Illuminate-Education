-- This query gives the SY19 MAP scores for currently enrolled students
WITH fall_read AS (
    WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Fall 2018-2019' AND
      "nwea_2019_Discipline" = 'Reading'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Fall 2018-2019' AND
      score."nwea_2019_Discipline" = 'Reading'
), winter_read AS (
   WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Winter 2018-2019' AND
      "nwea_2019_Discipline" = 'Reading'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Winter 2018-2019' AND
      score."nwea_2019_Discipline" = 'Reading'
), spring_read AS (
   WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Spring 2018-2019' AND
      "nwea_2019_Discipline" = 'Reading'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Spring 2018-2019' AND
      score."nwea_2019_Discipline" = 'Reading'
), fall_math AS (
   WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Fall 2018-2019' AND
      "nwea_2019_Discipline" = 'Mathematics'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Fall 2018-2019' AND
      score."nwea_2019_Discipline" = 'Mathematics'
), winter_math AS (
   WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Winter 2018-2019' AND
      "nwea_2019_Discipline" = 'Mathematics'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Winter 2018-2019' AND
      score."nwea_2019_Discipline" = 'Mathematics'
), spring_math AS (
   WITH
score AS (
  SELECT
      student_id,
      "nwea_2019_SchoolName",
      "nwea_2019_TermName",
      "nwea_2019_Discipline",
      max("nwea_2019_TestRITScore") AS score
    FROM national_assessments.nwea_2019
    WHERE
      "nwea_2019_TermName" = 'Spring 2018-2019' AND
      "nwea_2019_Discipline" = 'Mathematics'
GROUP BY
   student_id,
    "nwea_2019_SchoolName",
    "nwea_2019_TermName",
    "nwea_2019_Discipline"
  )
SELECT
      score."nwea_2019_SchoolName",
      student_session_aff.session_id,
      score."nwea_2019_TermName",
      score,
      score."nwea_2019_Discipline",
      local_student_id,
      students.first_name,
      students.last_name,
      student_session_aff.leave_date
    FROM students
      LEFT JOIN student_session_aff ON students.student_id = student_session_aff.student_id
      LEFT JOIN score ON students.student_id = score.student_id
    WHERE
      -- Only currently enrolled students reading scores from Fall testing
      student_session_aff.leave_date > DATE 'today' AND
      score."nwea_2019_TermName" = 'Spring 2018-2019' AND
      score."nwea_2019_Discipline" = 'Mathematics'
)
SELECT
  site_name,
  students.local_student_id,
  students.last_name,
  students.first_name,
  gender,
  grade_level_id -1 AS grade,
  fall_read.score AS fall_reading_score,
  fall_math.score AS fall_math_score,
  winter_read.score AS winter_reading_score,
  winter_math.score AS winter_math_score,
  spring_read.score AS spring_reading_score,
  spring_math.score AS spring_math_score
FROM student_session_aff
LEFT JOIN students ON student_session_aff.student_id = students.student_id
LEFT JOIN sessions ON student_session_aff.session_id = sessions.session_id
LEFT JOIN sites ON sessions.site_id = sites.site_id
LEFT JOIN fall_read ON students.local_student_id = fall_read.local_student_id AND fall_read.session_id = sessions.session_id
LEFT JOIN winter_read ON students.local_student_id = winter_read.local_student_id AND winter_read.session_id = sessions.session_id
LEFT JOIN spring_read ON students.local_student_id = spring_read.local_student_id AND spring_read.session_id = sessions.session_id
LEFT JOIN fall_math ON students.local_student_id = fall_math.local_student_id AND fall_math.session_id = sessions.session_id
LEFT JOIN winter_math ON students.local_student_id = winter_math.local_student_id AND winter_math.session_id = sessions.session_id
LEFT JOIN spring_math ON students.local_student_id = spring_math.local_student_id AND spring_math.session_id = sessions.session_id
WHERE
  -- Remove session id constraints for WA
  sessions.session_id <> 215 AND
  sessions.session_id <> 214 AND
  academic_year = 2019 AND
--     Filter for grades 6-10 to only get students who need to test
--   grade_level_id -1 IN (6,7,8,9,10) AND
  student_session_aff.leave_date > DATE 'today'
ORDER BY site_name, students.local_student_id
