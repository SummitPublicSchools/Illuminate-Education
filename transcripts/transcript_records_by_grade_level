-- This counts transcript course records by grade level, making sure that there are records from each grade level prior to the current one.
-- The boolean in the last column evaluates whether a grade level is missing from the transcript, implying that transfer grades have not been entered.

SELECT *,
  CASE WHEN current_grade = 12 THEN ninthrecs > 0 AND tenthrecs > 0 AND eleventhrecs > 0 ELSE
    CASE WHEN current_grade = 11 THEN ninthrecs > 0 AND tenthrecs > 0 ELSE
      CASE WHEN current_grade = 10 THEN ninthrecs > 0 ELSE FALSE END
    END
  END AS allgradesintranscript
FROM
  (SELECT
    sites.site_name                AS site,
    students.student_id            AS stuid,
    students.local_student_id      AS local_id,
    students.last_name             AS last_name,
    students.first_name            AS first_name,
    (sscurrent.grade_level_id - 1) AS current_grade,
    SUM (CASE WHEN sgt.grade_level_id = 10 THEN 1 ELSE 0 END) as ninthrecs,
    SUM (CASE WHEN sgt.grade_level_id = 11 THEN 1 ELSE 0 END) as tenthrecs,
    SUM (CASE WHEN sgt.grade_level_id = 12 THEN 1 ELSE 0 END) as eleventhrecs,
    SUM (CASE WHEN sgt.grade_level_id = 13 THEN 1 ELSE 0 END) as twelfthrecs

  FROM
    matviews.ss_current AS sscurrent

  LEFT JOIN matviews.student_grades_transcript sgt ON sscurrent.student_id = sgt.student_id
  LEFT JOIN sites ON sites.site_id = sscurrent.site_id
  LEFT JOIN students ON students.student_id = sscurrent.student_id

  WHERE
    sscurrent.site_id NOT IN (9999998, 9999999)
    AND sscurrent.grade_level_id > 10
    AND (sgt.grade_level_id > 9 OR sgt.grade_level_id IS NULL)
    AND (sgt.is_repeat IS FALSE OR sgt.is_repeat IS NULL)
    AND (sgt.school_course_id LIKE 'A%' OR sgt.school_course_id LIKE 'B%' OR sgt.school_course_id LIKE 'C%' OR
      sgt.school_course_id LIKE 'D%' OR sgt.school_course_id LIKE 'E%' OR sgt.school_course_id LIKE 'F%' OR
      sgt.school_course_id LIKE 'G%' OR sgt.school_course_id IS NULL)

  GROUP BY
    sites.site_name
    , students.student_id
    , students.local_student_id
    , students.last_name
    , students.first_name
    , sscurrent.grade_level_id)
    AS glcounts
