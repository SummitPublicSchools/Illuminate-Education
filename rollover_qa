/***************************************************************
Use: For QA after rollover executed
About: Pulls current non-senior students and their enrollment record for next academic year
***************************************************************/

WITH enrollment_future AS(
  SELECT
    student_id,
    grade_level_id - 1 AS grade,
    site_name,
    academic_year
    FROM student_session_aff enrollments
    LEFT JOIN sessions ON enrollments.session_id = sessions.session_id
    LEFT JOIN sites ON sessions.site_id = sites.site_id
  WHERE academic_year = date_part('year',CURRENT_DATE) +1
)

SELECT DISTINCT
  ss.student_id,
  students.local_student_id,
  enrollment_future.academic_year AS next_academic_year,
  enrollment_future.grade AS next_ay_grade,
  enrollment_future.site_name AS next_ay_site
  
FROM matviews.ss_current ss
LEFT JOIN enrollment_future ON enrollment_future.student_id = ss.student_id
LEFT JOIN students ON ss.student_id = students.student_id
--remove the 12th graders who should not have future enrollment
WHERE ss.grade_level_id <> 13
--comment in phrase below to see if any students do not have a future enrollment
--AND academic_year is NULL
