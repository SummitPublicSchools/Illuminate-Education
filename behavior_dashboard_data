with frl AS (
  SELECT
    enrollments.student_id,
    programs.student_program_id,
    programs.start_date,
    programs.end_date
  FROM public.student_session_aff AS enrollments
  -- only join programs with start_dates in current year
  -- note that direct cert students can have FRL program start dates as early as 07-01
  LEFT JOIN public.student_program_aff programs ON (enrollments.student_id = programs.student_id
                                                         AND programs.start_date >= '2017-07-01')
  LEFT JOIN codes.student_programs ON programs.student_program_id = student_programs.code_id
  LEFT JOIN public.sessions ON enrollments.session_id = sessions.session_id
  -- filter for FRL programs only (137: "Lunch - Reduced" ,136: "Lunch - Free")
  WHERE student_programs.code_key in ('137', '136')
    AND academic_year = 2018
),
  parent_ed AS (
    SELECT
      student_id,
      parent_education.code_translation AS parent_ed_level
    FROM public.students
    LEFT JOIN codes.parent_education ON students.parent_education_level = parent_education.code_id
    WHERE code_translation LIKE 'Not a High School Graduate'
  ),
  sed AS (
    SELECT
      student_id
    FROM frl
    UNION
    SELECT
      student_id
    FROM parent_ed
  ),
  current_house AS (
    SELECT DISTINCT
      enrollments.student_id,
      house_name,
      enrollments.session_id
    FROM student_session_aff AS enrollments
    LEFT JOIN sessions ON enrollments.session_id = sessions.session_id
    LEFT JOIN student_house_aff ON (enrollments.student_id = student_house_aff.student_id
                                                AND student_house_aff.session_id = enrollments.session_id)
    LEFT JOIN houses ON houses.house_id = student_house_aff.house_id
    WHERE academic_year = 2018
      AND leave_date >= current_date
  ),
  is_sped AS (
    SELECT
      enrollments.student_id,
      primary_disability.code_translation
    FROM public.student_session_aff AS enrollments
    LEFT JOIN student_specialed ON enrollments.student_id = student_specialed.student_id
    LEFT JOIN codes.primary_disability ON student_specialed.primary_disability = primary_disability.code_id
    LEFT JOIN sessions ON enrollments.session_id = sessions.session_id
    WHERE
    (student_specialed.exit_date is NULL
      OR student_specialed.exit_date >= CURRENT_DATE)
    AND primary_disability is NOT NULL
    AND academic_year = 2018
)

SELECT
  inc.incident_date :: DATE,
  stud.local_student_id,
  stud.last_name,
  stud.first_name,
  ss.grade_level_id - 1                           AS grade,
  house_name,
  engprof.code_translation                        AS english_proficiency,
  race_ethnicity_combined.combined_race_ethnicity AS federal_reported_race,
  CASE WHEN
    sed.student_id IS NULL
    THEN FALSE
    ELSE TRUE
    END                                             AS is_sed,
  CASE WHEN
    is_sped.student_id IS NULL
    THEN FALSE
    ELSE TRUE
    END                                              AS is_sped,
  bpar.code_translation AS participant_type,
  bcon.code_translation AS consequence_flag

FROM behavior.incidents inc
LEFT JOIN behavior.participants par ON par.incident_id = inc.incident_id
LEFT JOIN behavior.consequences con ON con.participant_id = par.participant_id
LEFT JOIN students stud ON stud.student_id = par.student_id
LEFT JOIN codes.english_proficiency engprof ON stud.english_proficiency = engprof.code_id
LEFT JOIN race_ethnicity_combined ON stud.student_id = race_ethnicity_combined.student_id
LEFT JOIN sed ON sed.student_id = stud.student_id
LEFT JOIN current_house ON stud.student_id = current_house.student_id
LEFT JOIN is_sped ON is_sped.student_id = stud.student_id
LEFT JOIN codes.behavior_status bs ON inc.status_id = bs.code_id
LEFT JOIN sites sites ON sites.site_id = inc.school_site_id
LEFT JOIN codes.behavior_consequences bcon ON con.consequence_type_id = bcon.code_id
LEFT JOIN codes.behavior_participants_roles bpar ON par.role_id = bpar.code_id
LEFT JOIN matviews.ss_current ss ON stud.student_id = ss.student_id

WHERE  incident_date > '2017-08-01'
  AND school_site_id <> 9999998
  AND bs.code_translation = 'Complete'
  AND bcon.code_translation <> 'Victim'
ORDER BY local_student_id